{% extends '::base.html.twig' %}

{% block body %}

    {% include 'AcmeBudgetTrackerBundle::navbar.html.twig' with {'var':'Home'} %}

    <div class="little-spacer text-center">

        {# Greeting and introduction to newcommers #}
        {% if newcommer == true %}
        
            <h1>Hello, {{app.user.username}}!</h1>
            <h3>... and welcome to BudgetTracker!</h3>
        
            <p class="lead big-spacer">
                We suggest you start by 
                <a href="{{ path('categories') }}">creating some categories</a> 
                to help you keep your expenses organised.
            </p>

            <p class="lead">
                Next, you can <a href="{{ path('months') }}">add your budget for the current month.</a>
            </p>

            <p class="lead">
                And then of course - start listing your <a href="{{ path('expenses') }}">expenses</a>.
            </p>

            <p class="lead">
                Whenever you want to see how much you have spent lately and for what -
                you can visit <a href="{{ path('reports') }}">reports section</a>.
                There you will see a list for just the expenses you are interested in.
            </p>
            
            <p class="lead">
                If you want just a quick overview for the current month, the home
                page will give you the needed information.
            </p>

            <p class="lead big-spacer">
               We have more nice features, too... comming soon. 
            </p>
            
        {% elseif expenses_for_current_month == null%}
            
            {# Created only categories, no expenses #}
            <p class="lead big-spacer">
                    <p class="lead little-spacer">Great!</p> 
                    <p class="lead little-spacer">You have successfully created some categories.</p> 
                    <p class="lead little-spacer">
                        Please <a href="{{ path('expenses') }}">add some expenses</a>, too.
                    </p>
            </p>
            
        {% else %}
            
            {# Experienced users #}
            <h3>Expenses for the current month</h3>
            
            {% if budget_for_current_month !=null %}
            
                {% if remaining > 0 %}
                    <p class="lead text-success">Remaining: 
                        <strong>{{ remaining }}</strong> 
                        (from {{ budget_for_current_month|number_format(2) }})
                    </p>
                {% elseif remaining == 0 %}
                    <p class="lead text-error">Remaining: 
                        <strong>{{ remaining }}</strong> 
                        (from {{ budget_for_current_month|number_format(2) }})
                    </p>
                    
                    <p class="lead text-error">
                        You have spent all your budget of {{ budget_for_current_month|number_format(2) }}!
                    </p>
                {% else %}
                    <p class="lead text-error">
                        You have exceeded your budget of {{ budget_for_current_month|number_format(2) }}!
                    </p>
                    
                    <p class="lead text-error">
                        You have spent <strong>{{ remaining|abs }}</strong> more than you should!</p> 
                    </p>
                {% endif %}
                    
            {% endif %}

            <button class="little-bottom-spacer btn {#btn-info#} toggle_expenses">
                <i class="icon-chevron-down {#icon-white#}"></i> Show/hide expenses
            </button>
            
            {# Displays categories, sums for them and expenses #}
            {% set current_category = first_category %}                      
            <h5>{{ first_category }}</h5> 

            {% set sum = 0 %}
            
            {% for e in expenses_for_current_month %}
                {% if e.category.name != current_category %}
                    <strong>{{ sum|number_format(2) }}</strong>
                    
                    <div class="little-spacer progress span5 center">
                        {% set percent = sum*100/sum_for_current_month//1 %}
                        <div class="bar" style="width:{{ percent }}%;">
                            {{ percent }}%
                        </div>
                    </div>
                            
                    {% set sum = 0 %}
                            
                    <h5>{{ e.category.name }}</h5>
                
                    {% set current_category = e.category.name %}
                    {% set sum = sum + e.price %}
                            
                    <div class="products">
                        <p>
                            {{ e.product }} - {{ e.price|number_format(2) }} 
                            {#{{ exp.date|date("d-m-Y") }}, {{ exp.category.name }}#}
                        </p>
                    </div>                          
                {% else %}                          
                    {% set sum = sum + e.price %}

                    <div class="products">
                        <p>
                            {{ e.product }} - {{ e.price|number_format(2) }} 
                            {#{{ exp.date|date("d-m-Y") }}, {{ exp.category.name }}#}
                        </p>
                    </div>
                {% endif %}                   
            {% endfor %}
            
            <strong>{{ sum|number_format(2) }}</strong>
            
            <div class="progress span5 center little-spacer">
                {% set percent = sum*100/sum_for_current_month//1 %}
                <div class="bar" style="width:{{ percent }}%;">
                    {{ percent }}%
                </div>
            </div>
                            
            <p class="lead text-error">Spent: <strong>{{sum_for_current_month|number_format(2)}}</strong></p>
                         
        {% endif %}
            
    </div>

    {%block javascript%}
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
        <script src="{{ asset('bundles/acmebudgettracker/js/home.js') }}"></script>
    {%endblock%}

{% endblock %}
        
{#----------------------------------------------------------------------------#}
        
{# TODO 1. <details><summary> ... for each category, not for all of them #}
{# TODO 2. When many items are shown ??? pagination? pop-ups? #}
{# TODO 3. Show sum for each category? or only the name and progress bar? #}
{# TODO 4. Little space below the button #}